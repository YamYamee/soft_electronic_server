# 자세 인식 WebSocket 서버

실시간으로 FSR(Force Sensitive Resistor) 센서 데이터를 받아 머신러닝 모델을 통해 사용자의 앉은 자세를 분석하는 WebSocket 서버입니다.

## 기능

- **WebSocket 서버**: 애플리케이션과 실시간 통신
- **자세 분류**: 8가지 앉은 자세 실시간 분석
- **머신러닝 모델**: 기 훈련된 모델을 사용한 빠른 예측
- **데이터베이스 저장**: SQLite를 사용한 예측 결과 저장
- **상세 로깅**: 서버 동작 및 성능 모니터링

## 지원 자세 분류

| ID | 자세명 | 설명 |
|----|--------|------|
| 0 | 정자세 | 올바른 앉은 자세 |
| 1 | 오른쪽 다리꼬기 | 오른쪽 다리를 왼쪽 다리 위에 올린 자세 |
| 2 | 왼쪽 다리꼬기 | 왼쪽 다리를 오른쪽 다리 위에 올린 자세 |
| 3 | 등 기대고 엉덩이 앞으로 | 등받이에 기대고 엉덩이가 앞으로 나온 자세 |
| 4 | 거북목(폰 보면서 목 숙이기) | 폰을 보면서 목을 아래로 숙인 자세 |
| 5 | 오른쪽 팔걸이 | 오른쪽 팔걸이에 팔을 올린 자세 |
| 6 | 왼쪽 팔걸이 | 왼쪽 팔걸이에 팔을 올린 자세 |
| 7 | 목 앞으로 나오는(컴퓨터 할 때) | 컴퓨터 작업 시 목이 앞으로 나온 자세 |

## 설치 및 실행

### 1. 요구사항

- Python 3.7 이상
- 필요한 패키지들은 자동으로 설치됩니다

### 2. 서버 실행

```bash
# 메인 서버 실행
python main.py
```

서버가 시작되면 `ws://localhost:8765`에서 WebSocket 연결을 받습니다.

### 3. 테스트 클라이언트 실행

```bash
# 대화형 테스트 클라이언트
python test_client.py

# 스트레스 테스트
python test_client.py stress
```

## API 사용법

### 클라이언트 → 서버 (센서 데이터 전송)

```json
{
    "id": "메시지 고유 ID",
    "device_id": "디바이스 고유 ID",
    "IMU": "IMU 센서 데이터 (선택적)",
    "FSR": [센서1, 센서2, ..., 센서11]
}
```

**예시:**
```json
{
    "id": 1,
    "device_id": "device_001",
    "IMU": {
        "accel": [0.1, 0.2, 9.8],
        "gyro": [0.01, 0.02, 0.03]
    },
    "FSR": [489, 625, 581, 483, 375, 517, 571, 530, 372, 398, 248]
}
```

### 서버 → 클라이언트 (예측 결과 응답)

```json
{
    "id": "요청 메시지 ID",
    "posture": "예측된 자세 ID (0-7)",
    "confidence": "신뢰도 (0.0-1.0)"
}
```

**예시:**
```json
{
    "id": 1,
    "posture": 0,
    "confidence": 0.923
}
```

### 에러 응답

```json
{
    "id": "요청 메시지 ID",
    "error": "에러 메시지",
    "details": "상세 에러 정보"
}
```

## 프로젝트 구조

```
soft_electronic_server/
├── main.py                 # 메인 실행 파일
├── websocket_server.py     # WebSocket 서버 구현
├── model_predictor.py      # 머신러닝 모델 예측 모듈
├── database.py             # 데이터베이스 관리 모듈
├── logger_config.py        # 로깅 설정 모듈
├── test_client.py          # 테스트 클라이언트
├── model_lr.joblib         # 훈련된 머신러닝 모델
├── posture_data.db         # SQLite 데이터베이스 (자동 생성)
├── logs/                   # 로그 파일 디렉토리
│   └── posture_server.log
└── FSR/                    # 훈련 데이터 (참조용)
    └── *.csv
```

## 데이터베이스 스키마

### posture_predictions (예측 결과)
- `id`: 기본키
- `client_id`: 클라이언트 ID
- `device_id`: 디바이스 ID
- `timestamp`: 예측 시간
- `predicted_posture`: 예측된 자세 (0-7)
- `confidence`: 신뢰도
- `imu_data`: IMU 센서 데이터
- `fsr_data`: FSR 센서 데이터

### client_connections (클라이언트 연결 로그)
- `id`: 기본키
- `client_id`: 클라이언트 ID
- `device_id`: 디바이스 ID
- `connect_time`: 연결 시간
- `disconnect_time`: 연결 해제 시간
- `is_active`: 활성 상태

## 로깅

서버는 다음과 같은 로그를 생성합니다:

- **콘솔 출력**: 실시간 서버 상태 모니터링
- **파일 로깅**: `logs/posture_server.log`에 상세 로그 저장
- **로그 로테이션**: 10MB 단위로 자동 회전 (최대 5개 파일 유지)

## 성능 모니터링

서버는 다음 메트릭을 주기적으로 로깅합니다:

- 연결된 클라이언트 수
- 초당 예측 처리 수
- 평균 응답 시간
- 서버 가동 시간

## 주의사항

1. **FSR 데이터 형식**: 11개의 숫자 배열로 전송해야 합니다
2. **연결 안정성**: WebSocket 연결이 불안정한 경우 자동으로 재연결을 시도하세요
3. **데이터 유효성**: 음수 값이나 비정상적인 센서 값은 자동으로 필터링됩니다
4. **보안**: 프로덕션 환경에서는 적절한 인증 및 암호화를 추가하세요

## 문제 해결

### 서버가 시작되지 않는 경우
1. 포트 8765가 사용 중인지 확인
2. Python 환경 및 패키지 설치 상태 확인
3. `model_lr.joblib` 파일이 존재하는지 확인

### 예측 정확도가 낮은 경우
1. FSR 센서 데이터가 올바른 형식인지 확인
2. 센서 배치가 훈련 데이터와 일치하는지 확인
3. 로그에서 데이터 유효성 검사 결과 확인

### 연결 문제
1. 방화벽 설정 확인
2. 서버 주소와 포트 번호 확인
3. 네트워크 연결 상태 확인

## 라이센스

이 프로젝트는 교육 및 연구 목적으로 제작되었습니다.

## 기여

버그 리포트나 기능 개선 제안은 이슈로 등록해 주세요.